---
phase: 02.1-typescript-migration
plan: "05"
type: execute
wave: 4
depends_on: ["02.1-03", "02.1-04"]
files_modified:
  - src/cli.ts
  - bin/index.js
  - test/smoke.test.js
autonomous: true
requirements: []

must_haves:
  truths:
    - "src/cli.ts exists with TypeScript types; src/cli.js deleted"
    - "npm run build succeeds — catalog is generated AND tsc compiles src/ to dist/ with zero errors"
    - "bin/index.js imports from dist/cli.js (not src/cli.js)"
    - "npx cc-templates --help produces the expected help output"
    - "npm run lint passes with zero errors on src/"
    - "npm pack --dry-run lists dist/ files and does NOT list src/ files"
  artifacts:
    - path: "src/cli.ts"
      provides: "CLI entry point with TypeScript types"
      exports: ["run"]
    - path: "bin/index.js"
      provides: "Entry shim pointing to compiled dist/"
      contains: "dist/cli.js"
    - path: "dist/cli.js"
      provides: "Compiled CLI output"
    - path: "test/smoke.test.js"
      provides: "Smoke tests verifying --help and build artifact integrity"
  key_links:
    - from: "bin/index.js"
      to: "dist/cli.js"
      via: "import { run } from '../dist/cli.js'"
      pattern: "dist/cli\\.js"
    - from: "dist/cli.js"
      to: "src/cli.ts"
      via: "tsc compilation"
      pattern: "tsc"
---

<objective>
Final plan: migrate src/cli.ts, update bin/index.js to point to dist/, run the full build, write smoke tests, and verify all five success criteria from the phase goal.

Purpose: This is the integration and verification plan — after this plan, the TypeScript migration is complete and the CLI works identically to before.
Output: src/cli.ts, updated bin/index.js, test/smoke.test.js, compiled dist/ directory.
</objective>

<execution_context>
@./.claude/get-shit-done/workflows/execute-plan.md
@./.claire/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/02.1-typescript-migration/02.1-CONTEXT.md
@.planning/phases/02.1-typescript-migration/02.1-RESEARCH.md
@.planning/phases/02.1-typescript-migration/02.1-03-SUMMARY.md
@.planning/phases/02.1-typescript-migration/02.1-04-SUMMARY.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Migrate src/cli.ts and update bin/index.js</name>
  <files>src/cli.ts, bin/index.js</files>
  <action>
Read `src/cli.js` and `bin/index.js` first.

**Migrate src/cli.ts:**
1. Create `src/cli.ts` from `src/cli.js` with TypeScript types
2. Import `InstallOptions` from `'./types.js'`
3. The `run` function signature becomes: `export async function run(): Promise<void>`
4. `program.opts()` should be typed: `const opts = program.opts<InstallOptions>()`
   - commander supports generic opts: `program.opts<InstallOptions>()` returns InstallOptions
5. All relative imports use `.js` extension: `import { runInstall } from './install.js'`
6. Keep all existing CLI logic unchanged — type-annotation-only migration
7. Remove JSDoc annotations; types are now in the signatures
8. For the `pkg` variable from JSON.parse: type it as `{ version: string }` or use `as { version: string }`
9. Delete `src/cli.js` after creating `src/cli.ts`

**Update bin/index.js:**
Change the import path from `'../src/cli.js'` to `'../dist/cli.js'`:

```javascript
#!/usr/bin/env node
import { run } from '../dist/cli.js';

run().catch(err => {
  console.error(err.message);
  process.exit(1);
});
```

This is the only change to bin/index.js — the shim stays as plain .js.

After both changes, run `npx tsc --noEmit` — fix any remaining type errors across the entire src/ tree. At this point ALL src/ files should be .ts with no remaining .js files (except cli.js already deleted). Common fixes:
- Extensionless imports: add `.js` extension
- Untyped `any`: add explicit `any` with `// TODO: type this properly`
- catch (err): add `instanceof Error` guard or cast
  </action>
  <verify>
    <automated>npx tsc --noEmit 2>&1 | tail -5</automated>
    <manual>Confirm src/cli.js is deleted. Confirm bin/index.js imports from ../dist/cli.js.</manual>
  </verify>
  <done>src/cli.ts exists with run(): Promise&lt;void&gt; export. bin/index.js imports from ../dist/cli.js. src/cli.js deleted. npx tsc --noEmit exits with zero errors.</done>
</task>

<task type="auto">
  <name>Task 2: Run full build, create smoke tests, verify phase success criteria</name>
  <files>test/smoke.test.js</files>
  <action>
**Step 1: Run the full build**

```bash
npm run build
```

This runs `node scripts/build-catalog.js && tsc`. It MUST succeed. If tsc errors remain from Task 1 fixes, address them now. The `dist/` directory must be created with `.js` and `.d.ts` files.

Verify: `ls dist/` shows cli.js, catalog.js, fetch.js, install.js, output.js, types.js, types.d.ts, and a dist/installers/ subdirectory.

**Step 2: Verify CLI still works**

```bash
node bin/index.js --help
```

The help output must appear (same as before migration). If it errors, debug: check dist/cli.js exists, check import paths in dist/ files are correct (should have .js extensions).

**Step 3: Run ESLint**

```bash
npm run lint
```

Fix any errors. Common issues:
- `@typescript-eslint/no-explicit-any`: If flagged on legitimate use (CJS interop), add `// eslint-disable-next-line @typescript-eslint/no-explicit-any` above the line. If flagged on avoidable uses, type them properly.
- `@typescript-eslint/no-unused-vars`: Remove unused variables or prefix with `_`

**Step 4: Create test/smoke.test.js**

Create `test/` directory and `test/smoke.test.js` using Node.js built-in `node:test` module (no additional test framework needed):

```javascript
// test/smoke.test.js
// Smoke tests: verify CLI build artifacts and --help output
import { test } from 'node:test';
import assert from 'node:assert/strict';
import { execSync } from 'node:child_process';
import { existsSync } from 'node:fs';

test('dist/cli.js exists after build', () => {
  assert.ok(existsSync('dist/cli.js'), 'dist/cli.js must exist');
});

test('dist/installers/ directory exists', () => {
  assert.ok(existsSync('dist/installers'), 'dist/installers/ must exist');
});

test('components.json exists', () => {
  assert.ok(existsSync('components.json'), 'components.json must exist');
});

test('bin/index.js --help exits with code 0 and contains cc-templates', () => {
  const output = execSync('node bin/index.js --help', { encoding: 'utf8' });
  assert.ok(output.includes('cc-templates'), '--help must mention cc-templates');
});

test('bin/index.js --version exits with code 0', () => {
  const output = execSync('node bin/index.js --version', { encoding: 'utf8' });
  // version string matches semver pattern
  assert.match(output.trim(), /^\d+\.\d+\.\d+/);
});
```

Add test script to package.json:
```json
"test": "node --test test/smoke.test.js"
```

**Step 5: Run tests**

```bash
npm test
```

All 5 smoke tests must pass.

**Step 6: Verify npm pack**

```bash
npm pack --dry-run
```

The output must:
- Include `dist/cli.js`, `dist/catalog.js` etc.
- Include `components.json`, `README.md`, `bin/index.js`
- NOT include `src/` files
  </action>
  <verify>
    <automated>npm run build 2>&1 | tail -3 && npm test 2>&1 | tail -10</automated>
    <manual>
1. Run: node bin/index.js --help — verify help output appears unchanged
2. Run: npm run lint — verify zero errors
3. Run: npm pack --dry-run — verify dist/ included, src/ excluded
    </manual>
  </verify>
  <done>npm run build exits 0 with dist/ populated. npm test passes all 5 smoke tests. npm run lint exits 0 with zero errors. npm pack --dry-run shows dist/ files and no src/ files. node bin/index.js --help shows expected output.</done>
</task>

</tasks>

<verification>
Run all five phase success criteria checks:
1. `ls src/**/*.ts && ls src/**/*.js` — only .ts in src/, no .js
2. `node bin/index.js --help` — help output appears
3. `npm run lint` — zero errors
4. `npm test` — all smoke tests pass
5. `npm pack --dry-run` — lists dist/ files, not src/ files
</verification>

<success_criteria>
All five ROADMAP success criteria for Phase 2.1 are met:
1. All source files (src/**) are .ts files; npm run build emits working .js to dist/
2. bin/index.js invokes compiled output; npx cc-templates --help still works
3. ESLint with TypeScript rules passes with zero errors on all source files
4. npm test passes — all smoke tests pass
5. npm pack --dry-run lists only the correct files (dist/, components.json, package.json, README)
</success_criteria>

<output>
After completion, create `.planning/phases/02.1-typescript-migration/02.1-05-SUMMARY.md`
</output>
