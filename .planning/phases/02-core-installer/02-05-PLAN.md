---
phase: 02-core-installer
plan: "05"
type: execute
wave: 3
depends_on:
  - "02-02"
  - "02-03"
  - "02-04"
files_modified:
  - src/install.js
  - src/cli.js
autonomous: false
requirements:
  - INST-05
  - INST-06
  - INST-07
  - SAFE-01
  - SAFE-04
  - COMP-01
  - COMP-02
  - COMP-03

must_haves:
  truths:
    - "User runs npx cc-templates --skill video-download and the skill installs end-to-end"
    - "User runs npx cc-templates --hook <name> and the hook merges into settings.json"
    - "Multiple flags in one invocation install each component: --skill foo --hook bar"
    - "First failure stops the invocation: error report says which component failed and why"
    - "User requests an unknown component and sees a clear error listing available options"
    - "User runs with --yes flag and no interactive prompts appear (CI-safe)"
    - "Running npx cc-templates with no install flags and no --list does not crash"
    - "User runs --global flag and files appear in ~/.claude/ instead of .claude/"
  artifacts:
    - path: "src/install.js"
      provides: "Multi-install orchestrator: reads opts, validates, dispatches to installers"
      exports: ["runInstall"]
    - path: "src/cli.js"
      provides: "Updated CLI with --agent, --force, --global, --yes, --verbose flags wired to runInstall"
  key_links:
    - from: "src/cli.js"
      to: "src/install.js"
      via: "await runInstall(opts) when any install flag is present"
      pattern: "runInstall"
    - from: "src/install.js"
      to: "src/installers/skill.js"
      via: "installSkill(name, opts)"
      pattern: "installSkill"
    - from: "src/install.js"
      to: "src/installers/agent.js"
      via: "installAgent(name, opts)"
      pattern: "installAgent"
    - from: "src/install.js"
      to: "src/installers/command.js"
      via: "installCommand(name, opts)"
      pattern: "installCommand"
    - from: "src/install.js"
      to: "src/installers/hook.js"
      via: "installHook(name, opts)"
      pattern: "installHook"
---

<objective>
Wire all four installers together: create src/install.js orchestrator (multi-install dispatch with fail-fast error handling) and update src/cli.js to add the missing --agent, --force, --global, --yes, --verbose flags, replace the Phase 1 stubs with a real runInstall() call, and handle the no-flags case gracefully.

Purpose: This is the integration seam — everything built in Waves 1-2 converges here. After this plan, the CLI is fully functional end-to-end.
Output: src/install.js, updated src/cli.js
</objective>

<execution_context>
@./.claude/get-shit-done/workflows/execute-plan.md
@./.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/02-core-installer/02-02-SUMMARY.md
@.planning/phases/02-core-installer/02-03-SUMMARY.md
@.planning/phases/02-core-installer/02-04-SUMMARY.md
@src/cli.js
@src/installers/skill.js
@src/installers/agent.js
@src/installers/command.js
@src/installers/hook.js
@src/fetch.js
@src/output.js
@src/catalog.js
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create src/install.js — multi-install orchestrator with fail-fast error handling</name>
  <files>src/install.js</files>
  <action>
Create `src/install.js` as the orchestrator that:
1. Resolves the base directory (INST-05: process.cwd() or os.homedir() based on --global flag)
2. Builds an ordered install plan from all component flags present in opts
3. Validates each component name against the catalog BEFORE starting any installs (SAFE-01)
4. Executes each install in plan order; on first error, reports which component failed and exits 1 (fail-fast per CONTEXT.md)
5. --yes flag (SAFE-04): suppresses interactive prompts — in Phase 2 there are no interactive prompts, so this flag is future-safe scaffolding only; accept and pass through

**Full implementation:**

```javascript
// src/install.js
import { homedir } from 'node:os';
import { installSkill } from './installers/skill.js';
import { installAgent } from './installers/agent.js';
import { installCommand } from './installers/command.js';
import { installHook } from './installers/hook.js';
import { validateName } from './catalog.js';
import { output } from './output.js';

/**
 * Run all installs requested by CLI opts.
 * Dispatches to per-type installers; fails fast on first error.
 * @param {object} opts - Parsed commander options
 *   { skill, agent, command, hook, mcp, force, global, yes, verbose, list }
 */
export async function runInstall(opts) {
  // Build ordered install plan from present flags
  // Each item: { type: string, name: string }
  const plan = [];

  // opts values: each flag is a single string (not array) per CONTEXT.md decision
  // "multiple flags in single invocation" means --skill foo --hook bar, not --skill foo bar
  if (opts.skill)   plan.push({ type: 'skill',   name: opts.skill });
  if (opts.agent)   plan.push({ type: 'agent',   name: opts.agent });
  if (opts.command) plan.push({ type: 'command', name: opts.command });
  if (opts.hook)    plan.push({ type: 'hook',    name: opts.hook });
  // opts.mcp: not implemented in Phase 2 (no INST-mcp requirement); skip silently

  if (plan.length === 0) {
    // No install flag provided — caller (cli.js) should have already handled this case,
    // but guard here to avoid silent no-op
    output.info('No components to install. Run --help for usage.');
    return;
  }

  // SAFE-01: Validate ALL names against catalog before starting any installs
  // This gives a clean error upfront rather than failing halfway through multi-install
  for (const item of plan) {
    try {
      validateName(item.type, item.name);
    } catch (err) {
      output.error(err.message);
      process.exit(1);
    }
  }

  // Execute each install in plan order; fail fast on first error
  for (const item of plan) {
    try {
      switch (item.type) {
        case 'skill':
          await installSkill(item.name, opts);
          break;
        case 'agent':
          await installAgent(item.name, opts);
          break;
        case 'command':
          await installCommand(item.name, opts);
          break;
        case 'hook':
          await installHook(item.name, opts);
          break;
        default:
          output.warn(`Unknown component type "${item.type}" — skipping`);
      }
    } catch (err) {
      // Fail fast: report which component failed and why, then exit 1
      output.error(`Failed to install ${item.type} "${item.name}": ${err.message}`);
      process.exit(1);
    }
  }
}
```

Note on individual installer signatures: agent.js, command.js, skill.js each accept `(name, opts)` — no separate `baseDir` argument. Each installer resolves baseDir internally from `opts.global`. This is consistent across all installer modules.
  </action>
  <verify>
    <automated>node --input-type=module &lt;&lt;&lt; "import { runInstall } from './src/install.js'; console.log('runInstall import OK', typeof runInstall);"</automated>
  </verify>
  <done>src/install.js created; exports runInstall; imports all four installers without error; plan is built from opts flags; fail-fast catch wraps each installer call; SAFE-01 validation runs on all items before any install starts.</done>
</task>

<task type="auto">
  <name>Task 2: Update src/cli.js — add new flags and wire runInstall</name>
  <files>src/cli.js</files>
  <action>
Rewrite `src/cli.js` (currently has Phase 1 stubs). Keep all existing flags (--skill, --hook, --command, --mcp, --list) and add the missing flags:
- `--agent <name>` (INST-02 — was missing from Phase 1, noted in RESEARCH.md open questions)
- `--force` boolean (INST-06)
- `--global` boolean (INST-05)
- `--yes` boolean (SAFE-04)
- `--verbose` boolean (per CONTEXT.md output decisions)

Replace all `[stub]` console.log blocks with a call to `runInstall(opts)`.

Handle the no-flags case: if neither an install flag nor --list is provided, print the help message (this is the Phase 3 interactive menu trigger — for now, showing help is the safe fallback).

**Full updated src/cli.js:**

```javascript
// src/cli.js
import { Command } from 'commander';
import { readFileSync } from 'node:fs';
import { join, dirname } from 'node:path';
import { fileURLToPath } from 'node:url';
import { runInstall } from './install.js';

const __dirname = dirname(fileURLToPath(import.meta.url));
const pkg = JSON.parse(readFileSync(join(__dirname, '../package.json'), 'utf8'));

export async function run() {
  const program = new Command();

  program
    .name('cc-templates')
    .description('Install Claude Code components with one command')
    .version(pkg.version, '-v, --version', 'Show version number')
    .helpOption('-h, --help', 'Show this help message');

  program.addHelpText('beforeAll', 'cc-templates — Install Claude Code components\n');

  // Component type flags (INST-01 through INST-04 + INST-02 agent)
  program
    .option('--skill <name>',   'Install a skill component')
    .option('--agent <name>',   'Install an agent component')
    .option('--hook <name>',    'Install a hook component')
    .option('--command <name>', 'Install a command component')
    .option('--mcp <name>',     'Install an MCP component (coming soon)')
    .option('--list',           'List all available components');

  // Behavior modifiers
  program
    .option('--force',   'Overwrite existing component without prompting (INST-06)')
    .option('--global',  'Install to ~/.claude/ instead of .claude/ (INST-05)')
    .option('--yes',     'Skip all confirmation prompts — CI mode (SAFE-04)')
    .option('--verbose', 'Show detailed output for each file written');

  program.addHelpText('after', `
Examples:
  npx cc-templates --list
  npx cc-templates --skill video-download
  npx cc-templates --skill video-download --global
  npx cc-templates --hook auto-format
  npx cc-templates --skill video-download --hook auto-format
  npx cc-templates --command git-summary --force
  npx cc-templates --skill video-download --yes`);

  program.parse(process.argv);

  const opts = program.opts();

  // --list: Phase 3 will implement the full interactive/catalog listing.
  // For Phase 2, print a stub message so the flag doesn't silently fail.
  if (opts.list) {
    console.log('[Phase 3] --list will show all available components. Coming soon.');
    return;
  }

  // Install flags: dispatch to runInstall orchestrator
  const hasInstallFlag = opts.skill || opts.agent || opts.command || opts.hook || opts.mcp;

  if (hasInstallFlag) {
    // opts.mcp is not implemented in Phase 2 — warn if attempted
    if (opts.mcp) {
      console.error('MCP install is not yet implemented. Check back in a future version.');
      process.exit(1);
    }
    await runInstall(opts);
    return;
  }

  // No flags: show help (Phase 3 will replace this with interactive menu — DISC-01)
  program.help();
}
```

**Note:** The `run()` function is now `async` because it calls `await runInstall(opts)`. The bin/index.js shim calls `run()` — verify it handles the returned Promise. If `bin/index.js` does `run()` without await, add `.catch(...)` or update it to `run().catch(err => { console.error(err.message); process.exit(1); })`.

Read `bin/index.js` before writing cli.js to confirm how run() is called, then update bin/index.js if needed to handle the async run().
  </action>
  <verify>
    <automated>node bin/index.js --help</automated>
    <manual>Help output shows all new flags: --agent, --force, --global, --yes, --verbose. No "[stub]" text appears. No unhandled promise rejection.</manual>
  </verify>
  <done>src/cli.js updated: exports async run(); imports runInstall from install.js; all 5 install flags + 4 modifier flags defined; --force, --global, --yes, --verbose present; Phase 1 stubs replaced; no-flags case shows help; node bin/index.js --help prints complete flag list without errors.</done>
</task>

<task type="checkpoint:human-verify" gate="blocking">
  <name>Task 3: Human verification of end-to-end install pipeline</name>
  <what-built>
    Complete Phase 2 Core Installer pipeline:
    - Plan 01: src/fetch.js, src/output.js, src/catalog.js, write-file-atomic dependency
    - Plan 02: src/installers/agent.js, src/installers/command.js
    - Plan 03: src/installers/skill.js (GitHub Contents API)
    - Plan 04: src/installers/hook.js (atomic write + array-append merge)
    - Plan 05 (this plan): src/install.js orchestrator, src/cli.js updated with all flags
  </what-built>
  <action>Verify the complete installer pipeline by running the manual checks below. All automated tasks in Plans 01-04 must be complete before this checkpoint.</action>
  <how-to-verify>
    1. **Help flag works:**
       ```
       node bin/index.js --help
       ```
       Expected: Shows all flags including --agent, --force, --global, --yes, --verbose. No [stub] text.

    2. **Unknown component gives useful error:**
       ```
       node bin/index.js --skill nonexistent-skill
       ```
       Expected: Error message containing "Available skills: video-download, video-fetch-and-summarize, video-summarizer"

    3. **Conflict detection works (SAFE-02):**
       ```
       mkdir -p .claude/skills/video-download
       node bin/index.js --skill video-download
       ```
       Expected: Warning "video-download already installed. Use --force to overwrite." (no files downloaded)
       ```
       rmdir .claude/skills/video-download
       ```

    4. **Skill install end-to-end (requires internet connection):**
       ```
       node bin/index.js --skill video-download --verbose
       ```
       Expected: Files appear in .claude/skills/video-download/; "Installed video-download skill to .claude/skills/video-download/" printed; verbose lines show each file written.
       Check: `ls .claude/skills/video-download/`

    5. **Multiple flags in one invocation:**
       ```
       node bin/index.js --skill video-summarizer --command some-command
       ```
       Expected: skill installs successfully; command fails with "Available commands:" list (no commands in catalog yet) — fail-fast stops after first failure.

    6. **CI mode (--yes flag, no prompts):**
       ```
       node bin/index.js --skill video-download --yes --force
       ```
       Expected: Completes without any interactive prompts.

    7. **Global install flag (INST-05):**
       ```
       node bin/index.js --skill video-download --global --force
       ```
       Expected: Files appear in ~/.claude/skills/video-download/ (check with `ls ~/.claude/skills/`). Clean up: `rm -rf ~/.claude/skills/video-download`
  </how-to-verify>
  <verify>
    <automated>node bin/index.js --help</automated>
    <manual>All 7 verification steps above completed successfully</manual>
  </verify>
  <done>All Phase 2 ROADMAP.md success criteria verified: (1) skill install works end-to-end, (2) hook merges into settings.json, (3) unknown component shows inline error list, (4) existing component aborts unless --force, (5) --yes flag runs without prompts.</done>
  <resume-signal>Type "approved" if all checks pass, or describe any issues encountered (include the command that failed and the actual output)</resume-signal>
</task>

</tasks>

<verification>
CLI help works cleanly:
```bash
node bin/index.js --help
```
Expected: Shows complete flag list, no errors, no [stub] text.

Unknown skill gives catalog error:
```bash
node bin/index.js --skill xyz-nonexistent 2>&1
```
Expected: Contains "Available skills: video-download..."

Import chain resolves without errors:
```bash
node --input-type=module <<< "import { run } from './src/cli.js'; console.log('cli.js loads OK');"
```
</verification>

<success_criteria>
- src/install.js: exports runInstall; dispatches to all four installers; validates ALL names before any install; fail-fast on first installer error with exit(1)
- src/cli.js: async run(); --agent, --force, --global, --yes, --verbose flags all present; runInstall called when any install flag is set; no-flags case shows help; --mcp gives "not yet implemented" message
- bin/index.js: handles async run() without unhandled rejection
- End-to-end: node bin/index.js --skill video-download installs to .claude/skills/video-download/ (with network)
- SAFE-04: --yes flag accepted without error; no prompts appear in Phase 2 flows
- INST-07: CC_TEMPLATES_REPO env var honored via fetch.js (inherited from Plan 01)
- Phase 2 Success Criteria from ROADMAP.md verified in human checkpoint
</success_criteria>

<output>
After completion, create `.planning/phases/02-core-installer/02-05-SUMMARY.md`
</output>
