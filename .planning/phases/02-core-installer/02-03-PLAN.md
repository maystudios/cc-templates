---
phase: 02-core-installer
plan: "03"
type: execute
wave: 2
depends_on:
  - "02-01"
files_modified:
  - src/installers/skill.js
autonomous: true
requirements:
  - INST-01
  - SAFE-01
  - SAFE-02
  - INST-05
  - INST-06
  - COMP-01
  - COMP-02
  - COMP-03

must_haves:
  truths:
    - "User runs npx cc-templates --skill video-download and the skill directory appears at .claude/skills/video-download/ with all files intact"
    - "If skill directory already exists and --force is not passed, install is aborted with one-liner warning"
    - "If --force is passed, existing skill directory is overwritten with a warning listing which skill will be replaced"
    - "If the skill name is not in the catalog, error message lists all available skills inline"
    - "All three seed skills (video-download, video-fetch-and-summarize, video-summarizer) are installable end-to-end"
  artifacts:
    - path: "src/installers/skill.js"
      provides: "Skill directory installer using GitHub Contents API"
      exports: ["installSkill"]
  key_links:
    - from: "src/installers/skill.js"
      to: "api.github.com/repos/.../contents/components/skills/<name>"
      via: "buildContentsApiUrl from fetch.js"
      pattern: "buildContentsApiUrl"
    - from: "src/installers/skill.js"
      to: "src/catalog.js"
      via: "validateName('skill', name) before any network call"
      pattern: "validateName"
---

<objective>
Implement the skill directory installer using the GitHub Contents API. Skills are the only component type stored as a directory (multiple files), so they require recursive directory traversal via the GitHub API rather than a single raw URL fetch.

Purpose: INST-01 is the most complex single-file installer path. The three seed skills (COMP-01, 02, 03) are verified installable by this module working end-to-end.
Output: src/installers/skill.js
</objective>

<execution_context>
@./.claude/get-shit-done/workflows/execute-plan.md
@./.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/02-core-installer/02-01-SUMMARY.md
@src/fetch.js
@src/output.js
@src/catalog.js
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create src/installers/skill.js — GitHub Contents API recursive directory installer</name>
  <files>src/installers/skill.js</files>
  <action>
Create `src/installers/skill.js`. Skills are directories that may contain multiple files at arbitrary depth. Use the GitHub Contents API (not raw URLs — raw URLs only work for individual files).

Required GitHub API headers — must be included on ALL Contents API calls:
```
Accept: application/vnd.github.v3+json
User-Agent: cc-templates
```

The GitHub Contents API returns an array: `[{ type: 'file'|'dir', name, download_url, url }, ...]`.
- For `type === 'file'`: fetch `item.download_url` (raw URL, no auth needed) and write to target
- For `type === 'dir'`: recursively call downloadDirectory with `item.url`

**Full implementation:**

```javascript
// src/installers/skill.js
import { existsSync, mkdirSync, writeFileSync } from 'node:fs';
import { join } from 'node:path';
import { homedir } from 'node:os';
import { buildContentsApiUrl } from '../fetch.js';
import { output } from '../output.js';
import { validateName } from '../catalog.js';

const GITHUB_HEADERS = {
  'Accept': 'application/vnd.github.v3+json',
  'User-Agent': 'cc-templates',
};

/**
 * Recursively download all files in a GitHub directory to a local target dir.
 * @param {string} apiUrl - GitHub Contents API URL for this directory
 * @param {string} targetDir - Local directory path to write files into
 * @param {object} opts - { verbose }
 * @returns {boolean} false if apiUrl returns 404, true on success
 */
async function downloadDirectory(apiUrl, targetDir, opts) {
  const res = await fetch(apiUrl, { headers: GITHUB_HEADERS });

  if (res.status === 404) return false;
  if (res.status === 403) {
    const body = await res.json().catch(() => ({}));
    const msg = body.message ?? 'forbidden';
    throw new Error(
      `GitHub API returned 403: ${msg}. ` +
      `You may have hit the unauthenticated rate limit (60 req/hour). ` +
      `Wait a minute and try again, or set GITHUB_TOKEN env var.`
    );
  }
  if (!res.ok) {
    throw new Error(`GitHub Contents API error: HTTP ${res.status} for ${apiUrl}`);
  }

  const items = await res.json();
  mkdirSync(targetDir, { recursive: true });

  for (const item of items) {
    if (item.type === 'file') {
      const fileRes = await fetch(item.download_url);
      if (!fileRes.ok) {
        throw new Error(`Failed to download file ${item.name} (HTTP ${fileRes.status})`);
      }
      const content = await fileRes.text();
      const filePath = join(targetDir, item.name);
      writeFileSync(filePath, content, 'utf8');
      if (opts.verbose) output.verbose(`  wrote ${item.name}`);
    } else if (item.type === 'dir') {
      await downloadDirectory(item.url, join(targetDir, item.name), opts);
    }
  }
  return true;
}

/**
 * Install a skill component (directory) to .claude/skills/<name>/
 * @param {string} name - Skill name
 * @param {object} opts - CLI options: { force, global, verbose }
 */
export async function installSkill(name, opts = {}) {
  // SAFE-01: validate before any network call
  validateName('skill', name);

  // INST-05: resolve base dir
  const baseDir = opts.global ? homedir() : process.cwd();
  const targetDir = join(baseDir, '.claude', 'skills', name);

  // SAFE-02: conflict check
  if (existsSync(targetDir)) {
    if (!opts.force) {
      output.warn(`${name} already installed. Use --force to overwrite.`);
      return { success: false, reason: 'exists' };
    }
    // INST-06: --force warns before overwriting
    output.warn(`Overwriting existing skill: ${name} (all files will be replaced)`);
  }

  const apiUrl = buildContentsApiUrl('skills', name);
  if (opts.verbose) output.verbose(`  fetching ${apiUrl}`);

  const found = await downloadDirectory(apiUrl, targetDir, opts);
  if (!found) {
    // Component was in catalog but not found on GitHub — data integrity issue
    throw new Error(
      `Skill "${name}" is listed in the catalog but not found on GitHub. ` +
      `This may be a temporary GitHub issue. Try again, or report a bug.`
    );
  }

  const displayPath = opts.global
    ? `~/.claude/skills/${name}/`
    : `.claude/skills/${name}/`;
  output.success(`Installed ${name} skill to ${displayPath}`);
  output.hint(`Use this skill in Claude Code with /${name}`);

  return { success: true };
}
```

**Anti-patterns to avoid (from RESEARCH.md):**
- Do NOT use `raw.githubusercontent.com` for skill directories — raw URLs only work for individual files
- Do NOT omit the User-Agent header — GitHub API rejects requests without it
- Do NOT replace existing arrays in hooks (N/A here, but keep in mind for hook.js)
- Always call `mkdirSync(..., { recursive: true })` before any write — the target directory may not exist yet
  </action>
  <verify>
    <automated>node --input-type=module &lt;&lt;&lt; "import { installSkill } from './src/installers/skill.js'; console.log('installSkill import OK', typeof installSkill); try { await installSkill('nonexistent-xyz', {}); } catch(e) { if (e.message.includes('Available skills')) { console.log('SAFE-01 OK'); } else { throw e; } }"</automated>
    <manual>Module imports without error; SAFE-01 fires for unknown skill names with inline list of available skills</manual>
  </verify>
  <done>src/installers/skill.js created; exports installSkill; SAFE-01 catalog validation fires before any network call; SAFE-02 conflict check on targetDir; GitHub Contents API called with correct Accept and User-Agent headers; recursive directory download implemented; rate limit 403 gives actionable error message.</done>
</task>

<task type="auto">
  <name>Task 2: Smoke-test skill install end-to-end against live GitHub</name>
  <files></files>
  <action>
Run a live install of `video-download` skill (COMP-01) to verify the full GitHub Contents API path works end-to-end. Use a temp directory to avoid polluting the project's .claude/ directory.

**Test procedure:**

```bash
# Create a temp target directory
mkdir -p /tmp/cc-test-skill/.claude/skills

# Run the installer pointed at the temp dir (set cwd via env workaround or pass baseDir)
# Since installSkill uses process.cwd() for baseDir when opts.global is false,
# run from the tmp dir or write a quick test script:

node --input-type=module <<'EOF'
import { installSkill } from './src/installers/skill.js';

// Override cwd is not directly possible, but we can test the fetch logic
// by checking that the GitHub Contents API URL resolves correctly.
// Full end-to-end test: create .claude/skills in cwd, run install, verify files.

import { mkdirSync, existsSync, readdirSync, rmSync } from 'node:fs';
import { join } from 'node:path';

const testTarget = join(process.cwd(), '.claude', 'skills', 'video-download');

// Clean up if exists
if (existsSync(testTarget)) {
  rmSync(testTarget, { recursive: true, force: true });
}

await installSkill('video-download', { verbose: true });

if (!existsSync(testTarget)) {
  throw new Error('Target directory not created');
}
const files = readdirSync(testTarget);
if (files.length === 0) {
  throw new Error('No files installed in skill directory');
}
console.log('COMP-01 OK — installed files:', files.join(', '));

// Clean up
rmSync(testTarget, { recursive: true, force: true });
console.log('Cleanup complete');
EOF
```

If the live GitHub fetch fails (network unavailable, rate limit), the test will emit a clear error. In that case:
1. Verify the URL printed in verbose mode matches the expected pattern: `https://api.github.com/repos/.../contents/components/skills/video-download`
2. Test SAFE-01 and SAFE-02 offline behavior only (still verify catalog and conflict logic work)
3. Note the live test result in the SUMMARY.md

Do NOT leave test artifacts (.claude/skills/video-download) in the project directory — clean up after the test.
  </action>
  <verify>
    <automated>node --input-type=module --eval "import { buildContentsApiUrl } from './src/fetch.js'; const url = buildContentsApiUrl('skills', 'video-download'); console.log('URL:', url); if (!url.includes('api.github.com')) throw new Error('wrong URL domain');"</automated>
    <manual>If network available: verify skill directory created with at least one file. If rate limited: note in summary, SAFE-01/02 tests still pass.</manual>
  </verify>
  <done>Skill installer verified: URL construction correct (api.github.com domain); if network available, video-download skill files downloaded and written to target; test artifacts cleaned up.</done>
</task>

</tasks>

<verification>
Import check:
```bash
node --input-type=module <<< "import { installSkill } from './src/installers/skill.js'; console.log(typeof installSkill);"
```
Expected: "function"

SAFE-01 check (unknown skill):
```bash
node --input-type=module <<< "
import { installSkill } from './src/installers/skill.js';
try {
  await installSkill('not-a-real-skill', {});
} catch(e) {
  console.log(e.message);
}"
```
Expected: message contains '"not-a-real-skill" is not a known skill. Available skills: video-download, video-fetch-and-summarize, video-summarizer'

SAFE-02 check (existing directory):
```bash
mkdir -p .claude/skills/video-download
node --input-type=module <<< "
import { installSkill } from './src/installers/skill.js';
const result = await installSkill('video-download', {});
console.log('result:', JSON.stringify(result));
"
rmdir .claude/skills/video-download
```
Expected: result = { success: false, reason: 'exists' }, warning printed to stderr
</verification>

<success_criteria>
- src/installers/skill.js: exports installSkill
- SAFE-01: unknown name → Error with inline list of available skills
- SAFE-02: existing dir + no --force → { success: false, reason: 'exists' } + one-liner warning
- INST-06: existing dir + --force → warning listing skill name, then overwrite proceeds
- INST-05: opts.global=true → targetDir uses homedir() base
- GitHub Contents API: called with Accept and User-Agent headers; recursive download handles nested files
- Rate limit 403: actionable error message (not a raw 403 crash)
- COMP-01/02/03: all three seed skills are installable when network is available
</success_criteria>

<output>
After completion, create `.planning/phases/02-core-installer/02-03-SUMMARY.md`
</output>
