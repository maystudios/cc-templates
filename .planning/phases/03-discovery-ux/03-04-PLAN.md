---
phase: 03-discovery-ux
plan: 04
type: execute
wave: 2
depends_on:
  - 03-01
  - 03-02
  - 03-03
files_modified:
  - src/cli.ts
autonomous: false
requirements:
  - DISC-01
  - DISC-02
  - DISC-03

must_haves:
  truths:
    - "Running `npx cc-templates` (no flags) launches the interactive two-level menu"
    - "Running `npx cc-templates --list` prints grouped components with author attribution"
    - "Running in a non-TTY context with no flags shows an error and exits 1 (no crash)"
    - "Ctrl+C or Escape from the menu exits with code 0 and no error message"
    - "Install flags (--skill, --agent, etc.) continue to work exactly as before"
    - "Full `npm run build` passes with zero TypeScript errors"
  artifacts:
    - path: "src/cli.ts"
      provides: "No-args menu routing, --list wiring, TTY guard, ExitPromptError handling"
      contains: "runMenu"
  key_links:
    - from: "src/cli.ts"
      to: "src/menu.ts"
      via: "import { runMenu } from './menu.js' + await runMenu() in no-args branch"
      pattern: "runMenu"
    - from: "src/cli.ts"
      to: "src/list.ts"
      via: "import { printList } from './list.js' + printList() when opts.list is true"
      pattern: "printList"
    - from: "src/cli.ts"
      to: "@inquirer/prompts"
      via: "import { ExitPromptError } from '@inquirer/prompts'"
      pattern: "ExitPromptError"
---

<objective>
Wire src/cli.ts to use runMenu() and printList(), then verify the full phase end-to-end via human checkpoint.

Purpose: This is the integration plan that connects all Phase 3 work. cli.ts is the single entry point — updating it activates menu routing (DISC-01), --list output (DISC-02), and the already-updated installers (DISC-03) all flow through from here.
Output: Updated src/cli.ts; full build passing; human-verified interactive menu and --list flag.
</objective>

<execution_context>
@./.claude/get-shit-done/workflows/execute-plan.md
@./.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/STATE.md
@.planning/ROADMAP.md
@.planning/phases/03-discovery-ux/03-CONTEXT.md
@.planning/phases/03-discovery-ux/03-RESEARCH.md
@.planning/phases/03-discovery-ux/03-01-SUMMARY.md
@.planning/phases/03-discovery-ux/03-02-SUMMARY.md
@.planning/phases/03-discovery-ux/03-03-SUMMARY.md
@src/cli.ts
@src/menu.ts
@src/list.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Update src/cli.ts — wire menu, list, TTY guard, ExitPromptError</name>
  <files>src/cli.ts</files>
  <action>
    Update `src/cli.ts` to replace the Phase 2 stubs with Phase 3 implementations.

    **New imports to add at the top (after existing imports):**
    ```typescript
    import { runMenu } from './menu.js';
    import { printList } from './list.js';
    import { ExitPromptError } from '@inquirer/prompts';
    ```

    **Replace the --list stub:**
    Old code (remove this block):
    ```typescript
    if (opts.list) {
      console.log('[Phase 3] --list will show all available components. Coming soon.');
      return;
    }
    ```
    New code:
    ```typescript
    if (opts.list) {
      printList();
      return;
    }
    ```

    **Replace the no-args fallback:**
    Old code (remove this):
    ```typescript
    // No flags: show help (Phase 3 will replace this with interactive menu — DISC-01)
    program.help();
    ```
    New code:
    ```typescript
    // No flags: launch interactive menu (DISC-01)
    if (!process.stdin.isTTY) {
      console.error('Interactive menu requires a terminal. Run with --help for usage.');
      process.exit(1);
    }
    try {
      await runMenu();
    } catch (err) {
      if (err instanceof ExitPromptError) {
        // User pressed Ctrl+C or Escape — clean exit, no message (locked decision)
        process.exitCode = 0;
        return;
      }
      throw err; // unexpected error — surface it
    }
    ```

    **Keep unchanged:** All program.option() declarations, program.addHelpText(), the hasInstallFlag block, and the opts.mcp error block remain exactly as they are.

    **Anti-patterns to avoid:**
    - Do NOT call process.exit(0) inside the ExitPromptError handler — use `process.exitCode = 0` + return
    - Do NOT keep `program.help()` anywhere in the no-args path — it calls process.exit() internally and will abort the async flow
    - Do NOT add a TTY check inside menu.ts — the guard belongs here in cli.ts
    - Do NOT remove the `import type { InstallOptions }` line — it's still used by `program.opts<InstallOptions>()`
  </action>
  <verify>
    <automated>npm run build 2>&1 | tail -10</automated>
    <manual>Check dist/cli.js exists; grep for 'runMenu' and 'printList' in dist/cli.js</manual>
  </verify>
  <done>npm run build passes with zero errors; dist/cli.js contains runMenu and printList references</done>
</task>

<task type="checkpoint:human-verify" gate="blocking">
  <name>Task 2: Human verify — interactive menu, --list, install with author attribution</name>
  <action>
    Pause for human verification of the complete Phase 3 Discovery UX. Claude has automated:
    - src/menu.ts: two-level @inquirer/select + @inquirer/search interactive menu
    - src/list.ts: TTY-aware grouped catalog listing with author attribution
    - All four installers: author suffix on success line, output.hint() removed
    - src/cli.ts: wired to runMenu(), printList(), ExitPromptError handler, TTY guard
  </action>
  <verify>
    <automated>npm run build 2>&1 | tail -5 && npm test 2>&1 | tail -5</automated>
    <manual>
      Run each check in the project directory:

      1. Build: `npm run build` — Expected: zero TypeScript errors, exits 0.

      2. --list flag: `node bin/index.js --list`
         Expected: grouped headers (## Skills, ## Agents, etc.), each entry with name + description + author, summary count at bottom.

      3. --list piped: `node bin/index.js --list | cat`
         Expected: same structure, no ANSI color codes.

      4. Interactive menu (real terminal only): `node bin/index.js`
         Expected: arrow-key type picker. Select type → component search with live filter. '← Back' returns to type picker. Select a component → immediate install with `✓ <name> installed to <path>  by <author>`.

      5. Ctrl+C clean exit: Start `node bin/index.js`, press Ctrl+C.
         Expected: exits silently, code 0, no error message.

      6. Existing flags still work: `node bin/index.js --help` still prints help; `node bin/index.js --skill <name>` still installs.

      7. Smoke tests: `npm test` — all pass.
    </manual>
  </verify>
  <done>All seven checks pass; human types "approved"</done>
  <resume-signal>Type "approved" if all checks pass, or describe any issues found</resume-signal>
</task>

</tasks>

<verification>
1. `npm run build` exits 0 with zero TypeScript errors
2. `npm test` passes (smoke tests)
3. `node bin/index.js --list` produces grouped output with summary count
4. `node bin/index.js --list | cat` produces same structure without ANSI codes
5. Interactive menu launches on `node bin/index.js` in a real terminal
6. Ctrl+C exits cleanly (code 0, no error message)
7. Human verified: arrow-key navigation, type-to-filter search, Back navigation, install with author attribution
</verification>

<success_criteria>
Phase 3 is complete when all three success criteria from ROADMAP.md are TRUE:
1. User runs `npx cc-templates` with no flags → two-level arrow-key menu → picks type → picks component → installs
2. User runs `npx cc-templates --list` → sees all components grouped by type with description and author attribution
3. After successful install → terminal output includes `by <author>` in the success line
</success_criteria>

<output>
After completion, create `.planning/phases/03-discovery-ux/03-04-SUMMARY.md` with:
- Confirmation of all three DISC requirements met
- Any issues found during human verification and how they were resolved
- Final npm test result
- Note: Phase 3 complete, Phase 4 (Polish + Publish) is next
</output>
